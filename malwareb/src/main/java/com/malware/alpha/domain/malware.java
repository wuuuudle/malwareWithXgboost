package com.malware.alpha.domain;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.malware.alpha.service.myJSON;
import com.mashape.unirest.http.HttpResponse;
import com.mashape.unirest.http.Unirest;
import com.mashape.unirest.http.exceptions.UnirestException;
import org.apache.commons.codec.binary.Hex;

import java.io.IOException;
import java.io.InputStream;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

public class malware {
    private static String apiKey = "ba2b15ae005862828e2964afc350fedaa439f8350aef709938ddb3c15a6d5708";
    private static String scan = "https://www.virustotal.com/vtapi/v2/file/scan";
    private static String report = "https://www.virustotal.com/vtapi/v2/file/report";


    private static String getReport(String resource, int model) throws UnirestException {
        while (true) {
            var obj = JSON.parseObject(Unirest
                    .get(report)
                    .queryString("apikey", apiKey)
                    .queryString("resource", resource)
                    .asString()
                    .getBody());
            if (obj.getInteger("response_code").equals(1)) {
                return new myJSON()
                        .put("sha1", obj.getString("sha1"))
                        .put("sha256", obj.getString("sha256"))
                        .put("md5", obj.getString("md5"))
                        .put("total", obj.getString("total"))
                        .put("positives", obj.getString("positives"))
                        .toJSONString();
            }
            if (model == 0)
                return null;
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }

    public static String getDetail(InputStream is) throws UnirestException, NoSuchAlgorithmException, IOException {
        var fileBytes = is.readAllBytes();
        var sha256 = Hex.encodeHexString(MessageDigest
                .getInstance("sha-256")
                .digest(fileBytes));
        var temp = getReport(sha256, 0);
        if (temp != null) return temp;
        var resource = JSON.parseObject(Unirest
                .post(scan)
                .field("apikey", apiKey)
                .field("file", fileBytes)
                .asString().getBody())
                .getString("resource");
        return getReport(resource, 1);
    }
}
